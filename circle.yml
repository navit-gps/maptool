machine:
  environment:
    MAPCODE: 150302
    MAP: ${CIRCLE_BRANCH}
dependencies:
  pre:
    - mkdir -p ~/assets/binmaps/
    - find  ~/assets/
    - sudo apt-get update
    - GEOFAB=$( echo $MAP | sed -e 's@europe-@europe/@' ); wget -c -O  ~/${MAP}-latest.osm.pbf http://download.geofabrik.de/${GEOFAB}-latest.osm.pbf
    - sudo apt-get install cmake 
    - sudo apt-get install g++
    - bash build.sh
  cache_directories:
    - "~/assets/"
test:
  post:
    - ./navit/bin/navit/maptool/maptool -P  -6 -s1 -e1 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin:
        timeout: 7200
    - ./navit/bin/navit/maptool/maptool -P  -6 -s2 -e2 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s3 -e3 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s4 -e4 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s5 -e5 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s6 -e6 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin:
       timeout: 7200
    - ./navit/bin/navit/maptool/maptool -P  -6 -s7 -e7 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s8 -e8 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s9 -e9 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s10 -e10 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s11 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
general:
  artifacts:
    - "~/assets/binmaps/"
deployment:
  update_metadatas:
    branch: /^((?!master).)*$/
    commands:
      - git config --global user.email "circleci@navit-project.org"
      - git config --global user.name "CircleCI"
      - git checkout master
      - git pull
      - touch maps.md
      - sed -i "/$MAP/d" maps.md
      - echo "* [$MAP]#${CIRCLE_BUILD_NUM}" >> maps.md
      - sort maps.md -o maps.md
      - cat maps.md
      - git add maps.md
      - git commit -m "Automated maps list update from ${CIRCLE_BRANCH}" maps.md
      - git push origin master

